<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlowMate: Stable Core App</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load React and Babel (Minimum necessary CDNs) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Base Styling for Clarity -->
    <style>
        body {
            background-color: #F7F7F7; /* Soft background */
            color: #0A0A0A;
            font-family: 'Inter', sans-serif;
        }
        /* Keep basic font styling for visual hierarchy */
        .playfair-text { font-family: 'Playfair Display', serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- The script MUST be type="text/babel" to compile the JSX -->
    <script type="text/babel">
    const { useEffect, useMemo, useState } = React;
    const { createRoot } = ReactDOM;

    // --- Simplified Design Tokens (for stability) ---
    const COLORS = {
      ACCENT: "#D4A373", // Rose Gold
      PRIMARY: "#0A0A0A", // Black
      PLUM: "#5E2A5E", // Plum
      BORDER: "#E6E0EB", // Light Gray
      WHITE: "#FFFFFF",
      CTA_GRADIENT: "bg-gradient-to-r from-purple-800 via-pink-700 to-yellow-600",
    };

    const LS_KEYS = {
      PROFILE: "gm_profile", REVIEWS: "gm_reviews", VOTES: "gm_votes", ROUTINE: "gm_routine",
      COMMENTS: "gm_comments",
    };

    const price = (p) => <span className={`font-semibold text-[${COLORS.ACCENT}]`}>‚Çπ{p.toLocaleString("en-IN")}</span>;

    function saveLS(key, val) {
      if (typeof window === "undefined") return;
      window.localStorage.setItem(key, JSON.stringify(val));
    }

    function loadLS(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch(e) {
        return fallback;
      }
    }

    // --- MINIMAL DATA (Simplified) ---
    const PRODUCTS = [
      {id:"p_spf1", brand:"Minimalist", name:"SPF 50 Gel", category:"sunscreen", priceMin:399, priceMax:599, tags:["no white cast"], score: 0.8},
      {id:"p_cleanser", brand:"Dot & Key", name:"Cica Cleanser", category:"cleanser", priceMin:595, priceMax:795, tags:["fragrance-free"], score: 0.9},
      {id:"p_moist", brand:"L‚ÄôOr√©al Paris", name:"UV Moisturizer", category:"moisturizer", priceMin:699, priceMax:999, tags:["hydrating"], score: 0.7},
      {id:"p_found", brand:"Maybelline", name:"Superstay Foundation", category:"foundation", priceMin:549, priceMax:799, tags:["matte"], score: 0.95},
    ];

    const INITIAL_REVIEWS = [
        { id: 'r_001', productId: 'p_spf1', rating: 4, text: "Great texture, absorbs fast. Good staple for oily skin.", skinType: 'oily', anon: true, createdAt: new Date().toISOString()},
    ];
    
    function getProduct(id) {
        return PRODUCTS.find(p => p.id === id);
    }
    
    function seedIfEmpty() {
      if (!localStorage.getItem(LS_KEYS.REVIEWS)) saveLS(LS_KEYS.REVIEWS, INITIAL_REVIEWS);
      if (!localStorage.getItem(LS_KEYS.ROUTINE)) saveLS(LS_KEYS.ROUTINE, { am: [], pm: [], makeup: [] });
      if (!localStorage.getItem(LS_KEYS.VOTES)) saveLS(LS_KEYS.VOTES, {r_001: 1});
      if (!localStorage.getItem(LS_KEYS.COMMENTS)) saveLS(LS_KEYS.COMMENTS, {});
    }

    // --- MINIMAL CORE LOGIC ---
    function rankProducts(category){
        const list = PRODUCTS.filter(p => p.category === category);
        return list.sort((a,b) => b.score - a.score);
    }

    function handleAIChat(userText) {
        const text = userText.toLowerCase().trim();
        if (/(recommend|sunscreen|pick)/.test(text)) {
             const ranked = rankProducts("sunscreen");
             return { role: 'assistant', text: `Based on your request, I recommend the ${ranked[0].brand} ${ranked[0].name}. Check the cards below!` };
        }
        if (/(routine|build|pm)/.test(text)) {
             return { role: 'assistant', text: `I can build your **PM Routine**! It needs a Cleanser, Treatment, and Moisturizer. See the Routine tab.` };
        }
        if (/(niacinamide|explain)/.test(text)) {
            return { role: 'assistant', text: `**Niacinamide** helps minimize pores and strengthen the skin barrier. A great ingredient for almost everyone!` };
        }
        return { role: 'assistant', text: `I'm still learning! Try asking for a "sunscreen recommendation" or to "explain niacinamide".` };
    }


    /********************\
    |* UI Helper Pieces *|
    /********************/
    const Section = ({title, children}) => (
      <div className="mb-8">
        <div className="flex items-center justify-between mb-4">
          <h3 className={`text-[26px] font-medium text-[${COLORS.PRIMARY}] playfair-text`}>{title}</h3>
        </div>
        <div className={`bg-white rounded-[18px] shadow-lg p-6 border border-[${COLORS.BORDER}]`}>{children}</div>
      </div>
    );

    const RatingStars = ({ rating }) => {
        const starArray = Array(5).fill(0).map((_, i) => i < Math.round(rating));
        return (
            <div className="flex items-center gap-0.5 text-yellow-500">
                {starArray.map((filled, i) => (
                    <span key={i} className={`text-[16px] ${filled ? 'opacity-100' : 'text-gray-300 opacity-100'}`}>‚òÖ</span>
                ))}
            </div>
        );
    };

    const ProductCardV2 = ({ p, onAddToRoutine }) => {
        const brandLogo = getBrandLogo(p.brand);

        const ButtonCTA = ({ label, slot, onClickHandler }) => (
            <button
                type="button"
                onClick={onClickHandler}
                className={`px-3 py-2 text-white font-bold text-[14px] rounded-[28px] ${COLORS.CTA_GRADIENT} hover:opacity-90 transition-opacity whitespace-nowrap`}
            >
                {label}
            </button>
        );

        return (
            <div className={`bg-white rounded-[18px] p-5 flex flex-col gap-3 shadow-md border border-[${COLORS.BORDER}]`}>
                <div className="flex flex-col gap-2">
                    <div className="flex items-center justify-between">
                        <div className="flex items-start gap-3">
                            <img src={brandLogo} alt={`${p.brand} logo`} className="w-8 h-8 rounded-full border border-gray-200" />
                            <div>
                                <div className={`font-medium text-[20px] text-[${COLORS.PRIMARY}] playfair-text`}>{p.name}</div>
                                <div className={`text-[14px] text-[${COLORS.MUTED_TEXT}]`}>{p.brand} | {p.category}</div>
                            </div>
                        </div>
                        <div className={`font-bold text-[16px]`}>{price(p.priceMin)}</div>
                    </div>

                    <div className="flex items-center pt-2">
                        <RatingStars rating={p.score * 5} />
                        <span className={`text-[14px] text-[${COLORS.MUTED_TEXT}] ml-2`}>({(p.score * 100).toFixed(0)}% community endorsement)</span>
                    </div>
                </div>

                <div className="flex flex-wrap gap-2 pt-2 border-t border-gray-100">
                    <ButtonCTA label="Add to AM" onClickHandler={() => onAddToRoutine(p, 'am')} />
                    <ButtonCTA label="Add to PM" onClickHandler={() => onAddToRoutine(p, 'pm')} />
                    <ButtonCTA label="Add to Makeup" onClickHandler={() => onAddToRoutine(p, 'makeup')} />
                </div>
            </div>
        );
    };


    export default function GlowMate(){
      seedIfEmpty();
      const [tab, setTab] = useState("discover");
      const [chat, setChat] = useState([{
        role:"assistant", text:"Welcome! Ask me for a recommendation or to build a routine. üå∏",
      }]);
      const [input, setInput] = useState(""); 
      const [isTyping, setIsTyping] = useState(false);
      const [routine, setRoutine] = useState(()=>loadLS(LS_KEYS.ROUTINE, {am:[], pm:[], makeup:[]}));
      const [reviews, setReviews] = useState(()=>loadLS(LS_KEYS.REVIEWS, INITIAL_REVIEWS));

      const handleChatSubmit = (e) => {
        e.preventDefault();
        if (!input.trim() || isTyping) return;
        const userTurn = {role:"user", text: input.trim()};
        
        setChat(ch=>[...ch, userTurn]);
        
        setIsTyping(true);
        setTimeout(() => {
            const reply = handleAIChat(userTurn.text);
            setChat(ch=>[...ch, reply]);
            setIsTyping(false);
        }, 1200);
        setInput("");
      }

      function addToRoutine(p, slot) {
        setRoutine(r => {
          const arr = [...r[slot]];
          if (!arr.find(x => x.id === p.id)) {
            arr.push({ id: p.id, name: `${p.brand} ${p.name}`, category: p.category });
          }
          return { ...r, [slot]: arr };
        });
      }
      function removeFromRoutine(slot, id){
        setRoutine(r=>({...r, [slot]: r[slot].filter(x=>x.id!==id)}));
      }
      
      const ranked = useMemo(() => rankProducts("sunscreen"), []);

      const ROUTINE_SLOTS = [
          { key: 'am', label: 'AM Routine', icon: '‚òÄÔ∏è' },
          { key: 'pm', label: 'PM Routine', icon: 'üåô' },
          { key: 'makeup', label: 'Makeup Routine', icon: 'üíÑ' },
      ];


      return (
        <div className={`min-h-screen bg-[${COLORS.PRIMARY}]/5 text-[${COLORS.PRIMARY}]`}>
          
          <header className={`sticky top-0 z-10 bg-white shadow-lg border-b border-[${COLORS.BORDER}] max-w-6xl mx-auto px-4 pt-4 pb-3`}>
            <div className="flex items-center justify-between">
              <div className={`font-semibold text-[28px] text-[${COLORS.PLUM}] playfair-text`}>GlowMate <span className={`text-[${COLORS.PLUM}]`}>‚óè</span></div>
              <nav className="flex gap-1">
                {[{k:"discover", label:"Home"}, {k:"routine", label:"Routine"}, {k:"community", label:"GlowCircle"}].map(t=> (
                  <button key={t.k} type="button" onClick={()=>setTab(t.k)} className={`px-4 py-2 rounded-[28px] text-[16px] font-bold transition-colors 
                    ${tab===t.k ? `bg-[${COLORS.PLUM}] text-white` : `hover:bg-gray-100 text-[${COLORS.PRIMARY}]`}`}>{t.label}</button>
                ))}
              </nav>
            </div>
          </header>

          <main className="max-w-6xl mx-auto px-4 pb-16 pt-6">
            {tab==="discover" && (
              <>
              <Section title="GlowMate Concierge">
                <div className={`h-72 overflow-y-auto border border-[${COLORS.BORDER}] rounded-[18px] p-4 flex flex-col gap-2 bg-gray-50`}>
                  {chat.map((m, i)=> (
                    <div key={i} className={`max-w-[85%] ${m.role==='assistant'?"self-start":"self-end"}`}>
                      <div className={`${m.role==='assistant' ? `bg-white border border-[${COLORS.BORDER}] text-[${COLORS.PRIMARY}]` : `bg-[${COLORS.ACCENT}] text-white`} rounded-[16px] p-3 text-[16px] shadow-sm`}>{m.text}</div>
                    </div>
                  ))}
                  {isTyping && (
                      <div className="self-start max-w-[85%]">
                          <div className={`bg-white border border-[${COLORS.BORDER}] rounded-[16px] p-3 text-[16px] shadow-sm`}>
                            <span className={`animate-pulse text-[${COLORS.PLUM}]`}>...</span>
                          </div>
                      </div>
                  )}
                </div>
                
                <form onSubmit={handleChatSubmit} className="mt-4 flex gap-3">
                  <input value={input} onChange={e=>setInput(e.target.value)} placeholder="Ask GlowMate anything..." className={`flex-1 px-4 py-3 rounded-xl border border-[${COLORS.BORDER}] text-[16px] bg-white text-[${COLORS.PRIMARY}]`}/>
                  <button type="submit" className={`px-6 h-12 text-white font-bold rounded-[28px] ${COLORS.CTA_GRADIENT} hover:opacity-90 transition-opacity`}>Send</button>
                </form>
              </Section>
              
              <Section title={`Top Picks: Sunscreen`}>
                <div className="grid md:grid-cols-2 gap-4">
                  {ranked.map(p=> (
                    <ProductCardV2 key={p.id} p={p} onAddToRoutine={addToRoutine} onStartReview={() => setTab('community')} />
                  ))}
                </div>
              </Section>
              </>
            )}

            {tab==="routine" && (
                <Section title="My Routine Builder">
                    <div className="grid grid-cols-3 gap-4 mb-6">
                        {ROUTINE_SLOTS.map(slot => (
                            <div key={slot.key} className={`text-center py-3 rounded-[18px] border border-[${COLORS.BORDER}] bg-gray-50`}>
                                <div className={`text-[20px] font-medium text-[${COLORS.PLUM}] playfair-text`}>
                                    {slot.icon} {slot.label}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="grid grid-cols-3 gap-4">
                        {ROUTINE_SLOTS.map(slot => (
                            <div key={slot.key} className="flex flex-col gap-3">
                                {routine[slot.key].map((item) => (
                                    <div key={item.id} className={`p-4 rounded-[18px] border border-[${COLORS.BORDER}] bg-white shadow-sm`}>
                                        <div className={`text-[16px] font-bold text-[${COLORS.PRIMARY}]`}>
                                            {item.name}
                                        </div>
                                        <div className={`text-[14px] text-[${COLORS.MUTED_TEXT}]`}>
                                            {item.category} | {item.brand}
                                        </div>
                                        <button 
                                            onClick={() => removeFromRoutine(slot.key, item.id)}
                                            className="mt-2 text-red-500 text-[14px] hover:underline"
                                        >
                                            Remove
                                        </button>
                                    </div>
                                ))}
                                {routine[slot.key].length === 0 && (
                                    <div className={`p-4 text-[14px] text-[${COLORS.MUTED_TEXT}] italic rounded-[18px] border border-dashed border-gray-300`}>
                                        No items added.
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </Section>
            )}

            {tab==="community" && (
                <Section title="GlowCircle Feed">
                    <p className="mb-4 text-sm text-gray-600">Mini reviews from the community.</p>
                    <div className="space-y-4">
                        {loadLS(LS_KEYS.REVIEWS, []).map(r => (
                            <div key={r.id} className="p-4 bg-white rounded-[18px] shadow-sm border border-[${COLORS.BORDER}]">
                                <div className="font-semibold">{getProduct(r.productId).name}</div>
                                <div className="flex items-center gap-2 mb-2">
                                    <RatingStars rating={r.rating} />
                                    <span className="text-sm text-gray-500">({r.rating}.0/5)</span>
                                </div>
                                <p className="text-sm italic">{r.text}</p>
                                <div className="mt-2 text-xs text-gray-400">User: {r.anon ? "Anonymous" : "Community Member"}</div>
                            </div>
                        ))}
                    </div>
                </Section>
            )}
            
          </main>
        </div>
      );
    }
    
    // RENDER THE MAIN COMPONENT
    const root = createRoot(document.getElementById('root'));
    root.render(<GlowMate />);
    </script>
</body>
</html>
